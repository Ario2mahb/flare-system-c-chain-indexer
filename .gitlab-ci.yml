stages:
  - build
  - test

variables:
  GOPATH: /go
  MYSQL_ROOT_PASSWORD: root
  MYSQL_DATABASE: flare_ftso_indexer_test

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${GOPATH}/pkg/mod
    - ${GOPATH}/bin


Build:
  stage: build
  image: golang:1.21
  before_script:
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
  script:
    - '! gofmt -l . | grep -q .'
    - golangci-lint run --timeout 5m0s
    - go build ./...

Test:
  stage: test
  image: golang:1.21
  variables:
    DB_HOST: mysql
    DB_PORT: 3306
    DB_NAME: ${MYSQL_DATABASE}
    DB_USERNAME: root
    DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    MOCK_CHAIN_PORT: 2426
  services:
    - mysql:latest
  before_script:
    - apt-get update && apt-get install -y wget
    - wget -O /usr/local/bin/wait-for-it.sh https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
    - chmod +x /usr/local/bin/wait-for-it.sh
  script:
    - /usr/local/bin/wait-for-it.sh "${DB_HOST}:${DB_PORT}" --timeout=300 && echo "MySQL is up"
    - go test ./...
